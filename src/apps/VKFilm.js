import React from 'react';
import bridge from '@vkontakte/vk-bridge';
import '../css/VKFilm.css';
import '../css/Fonts.css';

import {
    AppRoot, Avatar,
    Button, CustomSelect, Input, ModalCard, ModalRoot,
    Panel,
    Placeholder, ScreenSpinner, Select, Text, Title,
    View, Spacing, ButtonGroup
} from '@vkontakte/vkui';

import {ReactComponent as IconResult} from "../assets/icons_death_date/2/megaphone (1).svg";
import RoundProgress from "../components/BattleStat/RoundProgress";
import {
    convertTextToLines,
    ctxDrawImageWithRound,
    get, getBase64Image, getFilesYaDisk,
    getUrlParams, getYaDiskImage,
    loadCrossOriginImage,
    loadFonts, openUrl, replaceExtensionPath, shortIntegers, sleep,
    toBlob
} from "../js/utils";
import {decOfNum, getRandomInt} from "../js/utils";
import fetch from "node-fetch";
import {createCanvas, loadImage} from "canvas";
import {
    defaultModalProps,
    defaultModalRootProps,
    defaultViewProps,
    initializeNavigation
} from "../js/defaults/navigation";
import {
    getStorageValue,
    getToken,
    setStorageValue,
    shareAlbumPhoto, shareWallPhoto,
    subscribeBridgeEvents, vkApi
} from "../js/defaults/bridge_utils";
import {
    allowGroupMessages,
    getAppInfo,
    inputsSexAndYears,
    proxyUrl,
    subscribeGroup
} from "../js/defaults/catalin_tg_bot";
import {} from "@vkontakte/icons";
import Lottie from "lottie-react";
import html2canvas from "html2canvas";

const folderUrl = 'https://disk.yandex.ru/d/zgpU0h6dFEf12Q';

export default class extends React.Component {

    constructor(props) {
        super(props);

        this.state = {}

        initializeNavigation.bind(this)('main');

        this.selectCategory = this.selectCategory.bind(this);
        this.getRandomFilm = this.getRandomFilm.bind(this);
        this.getStoryCanvas = this.getStoryCanvas.bind(this);
        this.shareStory = this.shareStory.bind(this);
        this.shareAlbum = this.shareAlbum.bind(this);

        this.lottie_ref = React.createRef();
    }

    async componentDidMount() {
        subscribeBridgeEvents({}, 'space_gray');
        this.changeStatusBarColor();

        const app = await getAppInfo();
        await this.setState({...app});
        await bridge.send('VKWebAppInit');

        this.setPopout(<ScreenSpinner/>);
        await this.getCategories();
        await loadFonts(['Akrobat Black', 'Akrobat ExtraBold', 'Wix Madefor Display Medium']);
        this.setPopout(null);
    }

    async getCategories() {
        const folderData = await getFilesYaDisk(folderUrl);
        const categories = {};
        for (const folder of folderData.filter(item => item.type === 'dir')) {
            let poster_url = (folderData.find(item => item.type === 'file' && replaceExtensionPath(item.name) === folder.name) || {preview: ''}).preview.split('&').map(value =>
                value.includes('size=') ? 'size=XXXL' : value
            ).join('&');
            if (poster_url) {
                poster_url = await getYaDiskImage(poster_url);
            } else {
                poster_url = 'https://i.postimg.cc/Kz4pkrV7/Frame-2.png';
            }

            categories[folder.name] = {
                poster_url,
                folder_url: folder.public_url
            };
        }
        this.setState({categories, category: Object.keys(categories)[0]});
    }

    async getRandomFilm() {
        const {categories, category} = this.state;
        const folderData = await getFilesYaDisk(categories[category].folder_url + '&limit=200');
        const film = folderData.filter(value => value.type === 'file')[getRandomInt(0, folderData.length - 1)];
        const poster_url = await getYaDiskImage(film.preview.split('&').map(value =>
            value.includes('size=') ? 'size=XXXL' : value
        ).join('&'));

        await this.setState({
            film: {
                poster_url,
                name: replaceExtensionPath(film.name)
            }
        });
    }

    changeStatusBarColor() {
        if (bridge.supports('VKWebAppSetViewSettings')) {
            bridge.send('VKWebAppSetViewSettings', {
                status_bar_style: 'light',
                action_bar_color: '#330000'
            });
        }
    }

    async selectCategory() {
        this.getRandomFilm();
        this.category_container.style.opacity = 0;
        setTimeout(() => {
            this.category_container.style.display = 'none';
        }, 399);
        await sleep(200);

        this.lottie_ref.current.animationContainerRef.current.style.display = 'block';
        this.lottie_ref.current.animationContainerRef.current.style.opacity = 1;
        this.lottie_ref.current.play();
        await sleep(this.lottie_ref.current.getDuration(false) * 1000 - 200);
        this.lottie_ref.current.animationContainerRef.current.style.opacity = 0;
        this.film_container.style.display = 'block';
        this.film_container.style.opacity = 1;
        await sleep(100);
        this.lottie_ref.current.animationContainerRef.current.style.display = 'none';

        for (let i = 0; i < 1; i++) {
            if (this.state.film && this.state.film.poster_url) {
                this.shareAlbum();
            } else {
                await sleep(1000);
                i--;
            }
        }
    }

    async getStoryCanvas() {
        const
            {category, film} = this.state,
            {createCanvas, loadImage} = require('canvas'),
            canvas = createCanvas(1080, 1920),
            ctx = canvas.getContext('2d'),
            background = await loadImage(film.poster_url),
            bottomImg = await loadImage('data:image/svg+xml,%3Csvg%20width%3D%22909%22%20height%3D%22236%22%20viewBox%3D%220%200%20909%20236%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22909%22%20height%3D%22202%22%20rx%3D%22101%22%20fill%3D%22%23FFBB00%22%2F%3E%3Cpath%20d%3D%22M137.012%2091H129.344V60.49H121.568V91H113.9V53.2H137.012V91ZM153.947%2053.2C157.871%2053.2%20160.931%2054.334%20163.127%2056.602C165.323%2058.87%20166.421%2062.02%20166.421%2066.052C166.421%2070.084%20165.323%2073.234%20163.127%2075.502C160.931%2077.734%20157.871%2078.85%20153.947%2078.85H150.653V91H142.985V53.2H153.947ZM153.839%2071.56C155.387%2071.56%20156.557%2071.092%20157.349%2070.156C158.141%2069.22%20158.537%2067.852%20158.537%2066.052C158.537%2064.216%20158.141%2062.83%20157.349%2061.894C156.557%2060.958%20155.387%2060.49%20153.839%2060.49H150.653V71.56H153.839ZM169.961%2053.2H177.413V61.948C177.413%2063.784%20177.323%2066.142%20177.143%2069.022C176.963%2071.866%20176.729%2074.422%20176.441%2076.69L176.603%2076.852L177.575%2074.206C178.295%2072.226%20178.889%2070.696%20179.357%2069.616L186.539%2053.2H194.045V91H186.593V83.332C186.593%2081.1%20186.665%2078.436%20186.809%2075.34C186.989%2072.244%20187.205%2069.562%20187.457%2067.294L187.295%2067.132L186.323%2069.832C185.099%2073.144%20184.271%2075.322%20183.839%2076.366L177.467%2091H169.961V53.2ZM196.7%2084.736C197.528%2084.736%20198.194%2084.592%20198.698%2084.304C199.202%2084.016%20199.652%2083.476%20200.048%2082.684C200.444%2081.892%20200.786%2080.704%20201.074%2079.12C201.398%2077.32%20201.668%2074.728%20201.884%2071.344C202.1%2067.96%20202.424%2061.912%20202.856%2053.2H224.078V91H216.41V60.436H210.2C209.696%2070.12%20209.102%2077.014%20208.418%2081.118C207.95%2084.034%20207.194%2086.266%20206.15%2087.814C205.142%2089.326%20203.882%2090.352%20202.37%2090.892C200.894%2091.396%20199.004%2091.648%20196.7%2091.648V84.736ZM241.261%2091.648C237.409%2091.648%20234.403%2090.514%20232.243%2088.246C230.083%2085.942%20229.003%2082.774%20229.003%2078.742V65.458C229.003%2061.426%20230.083%2058.276%20232.243%2056.008C234.403%2053.704%20237.409%2052.552%20241.261%2052.552C245.113%2052.552%20248.119%2053.704%20250.279%2056.008C252.439%2058.276%20253.519%2061.426%20253.519%2065.458V78.742C253.519%2082.774%20252.439%2085.942%20250.279%2088.246C248.119%2090.514%20245.113%2091.648%20241.261%2091.648ZM241.261%2084.196C242.701%2084.196%20243.781%2083.746%20244.501%2082.846C245.221%2081.91%20245.581%2080.542%20245.581%2078.742V65.458C245.581%2063.658%20245.221%2062.308%20244.501%2061.408C243.781%2060.472%20242.701%2060.004%20241.261%2060.004C239.821%2060.004%20238.741%2060.472%20238.021%2061.408C237.301%2062.308%20236.941%2063.658%20236.941%2065.458V78.742C236.941%2080.542%20237.301%2081.91%20238.021%2082.846C238.741%2083.746%20239.821%2084.196%20241.261%2084.196ZM278.894%2076.798L277.112%2079.66V91H269.66V79.66L267.878%2076.798L261.344%2091H252.92L263.828%2070.156L253.946%2053.2H262.586L267.716%2063.46L269.66%2067.834V53.2H277.112V67.834L279.056%2063.46L284.186%2053.2H292.826L282.944%2070.156L293.852%2091H285.428L278.894%2076.798ZM316.039%2083.71V91H296.005V53.2H315.499V60.49H303.673V68.32H314.419V75.34H303.673V83.71H316.039ZM343.775%2053.2V91H336.053V75.61H328.277V91H320.555V53.2H328.277V68.32H336.053V53.2H343.775ZM349.746%2053.2H357.198V61.948C357.198%2063.784%20357.108%2066.142%20356.928%2069.022C356.748%2071.866%20356.514%2074.422%20356.226%2076.69L356.388%2076.852L357.36%2074.206C358.08%2072.226%20358.674%2070.696%20359.142%2069.616L366.324%2053.2H373.83V91H366.378V83.332C366.378%2081.1%20366.45%2078.436%20366.594%2075.34C366.774%2072.244%20366.99%2069.562%20367.242%2067.294L367.08%2067.132L366.108%2069.832C364.884%2073.144%20364.056%2075.322%20363.624%2076.366L357.252%2091H349.746V53.2ZM399.867%2083.71V91H379.833V53.2H399.327V60.49H387.501V68.32H398.247V75.34H387.501V83.71H399.867ZM437.596%2091H429.928V60.49H422.152V91H414.484V53.2H437.596V91ZM454.747%2091.648C450.895%2091.648%20447.889%2090.514%20445.729%2088.246C443.569%2085.942%20442.489%2082.774%20442.489%2078.742V65.458C442.489%2061.426%20443.569%2058.276%20445.729%2056.008C447.889%2053.704%20450.895%2052.552%20454.747%2052.552C458.599%2052.552%20461.605%2053.704%20463.765%2056.008C465.925%2058.276%20467.005%2061.426%20467.005%2065.458V78.742C467.005%2082.774%20465.925%2085.942%20463.765%2088.246C461.605%2090.514%20458.599%2091.648%20454.747%2091.648ZM454.747%2084.196C456.187%2084.196%20457.267%2083.746%20457.987%2082.846C458.707%2081.91%20459.067%2080.542%20459.067%2078.742V65.458C459.067%2063.658%20458.707%2062.308%20457.987%2061.408C457.267%2060.472%20456.187%2060.004%20454.747%2060.004C453.307%2060.004%20452.227%2060.472%20451.507%2061.408C450.787%2062.308%20450.427%2063.658%20450.427%2065.458V78.742C450.427%2080.542%20450.787%2081.91%20451.507%2082.846C452.227%2083.746%20453.307%2084.196%20454.747%2084.196ZM500.32%2083.818V97.426H492.706V91H476.344V97.426H468.784V83.818H471.214C473.914%2080.902%20475.408%2075.934%20475.696%2068.914L476.29%2053.2H496.81V83.818H500.32ZM489.25%2060.436H483.472L483.04%2071.182C482.86%2076.33%20481.888%2080.542%20480.124%2083.818H489.25V60.436ZM503.48%2053.2H524.486V60.382H511.202V67.618H514.766C518.654%2067.618%20521.588%2068.68%20523.568%2070.804C525.584%2072.928%20526.592%2075.772%20526.592%2079.336C526.592%2083.332%20525.62%2086.284%20523.676%2088.192C521.768%2090.064%20518.798%2091%20514.766%2091H503.48V53.2ZM514.118%2083.71C517.178%2083.71%20518.708%2082.252%20518.708%2079.336C518.708%2076.312%20517.178%2074.8%20514.118%2074.8H511.202V83.71H514.118ZM550.648%2083.71V91H530.614V53.2H550.108V60.49H538.282V68.32H549.028V75.34H538.282V83.71H550.648ZM566.126%2053.2C570.05%2053.2%20573.11%2054.334%20575.306%2056.602C577.502%2058.87%20578.6%2062.02%20578.6%2066.052C578.6%2070.084%20577.502%2073.234%20575.306%2075.502C573.11%2077.734%20570.05%2078.85%20566.126%2078.85H562.832V91H555.164V53.2H566.126ZM566.018%2071.56C567.566%2071.56%20568.736%2071.092%20569.528%2070.156C570.32%2069.22%20570.716%2067.852%20570.716%2066.052C570.716%2064.216%20570.32%2062.83%20569.528%2061.894C568.736%2060.958%20567.566%2060.49%20566.018%2060.49H562.832V71.56H566.018ZM602.174%2083.71V91H582.14V53.2H601.634V60.49H589.808V68.32H600.554V75.34H589.808V83.71H602.174ZM626.832%2060.49H619.434V91H611.55V60.49H604.152V53.2H626.832V60.49ZM651.893%2090.46H651.191C648.779%2090.46%20646.565%2089.902%20644.549%2088.786C642.569%2087.67%20640.985%2086.05%20639.797%2083.926C638.645%2081.766%20638.069%2079.228%20638.069%2076.312V68.32C638.069%2065.368%20638.645%2062.794%20639.797%2060.598C640.985%2058.402%20642.569%2056.728%20644.549%2055.576C646.565%2054.388%20648.779%2053.794%20651.191%2053.794H651.893V49.744H659.453V53.794H660.155C662.567%2053.794%20664.763%2054.388%20666.743%2055.576C668.759%2056.728%20670.343%2058.402%20671.495%2060.598C672.683%2062.794%20673.277%2065.368%20673.277%2068.32V76.312C673.277%2079.228%20672.683%2081.766%20671.495%2083.926C670.343%2086.05%20668.759%2087.67%20666.743%2088.786C664.763%2089.902%20662.567%2090.46%20660.155%2090.46H659.453V94.726H651.893V90.46ZM651.893%2083.116V61.138H650.813C649.337%2061.138%20648.113%2061.732%20647.141%2062.92C646.169%2064.072%20645.683%2065.872%20645.683%2068.32V76.312C645.683%2078.652%20646.169%2080.38%20647.141%2081.496C648.113%2082.576%20649.337%2083.116%20650.813%2083.116H651.893ZM660.533%2083.116C662.009%2083.116%20663.233%2082.576%20664.205%2081.496C665.177%2080.38%20665.663%2078.652%20665.663%2076.312V68.32C665.663%2065.872%20665.177%2064.072%20664.205%2062.92C663.233%2061.732%20662.009%2061.138%20660.533%2061.138H659.453V83.116H660.533ZM676.965%2053.2H684.417V61.948C684.417%2063.784%20684.327%2066.142%20684.147%2069.022C683.967%2071.866%20683.733%2074.422%20683.445%2076.69L683.607%2076.852L684.579%2074.206C685.299%2072.226%20685.893%2070.696%20686.361%2069.616L693.543%2053.2H701.049V91H693.597V83.332C693.597%2081.1%20693.669%2078.436%20693.813%2075.34C693.993%2072.244%20694.209%2069.562%20694.461%2067.294L694.299%2067.132L693.327%2069.832C692.103%2073.144%20691.275%2075.322%20690.843%2076.366L684.471%2091H676.965V53.2ZM703.704%2084.736C704.532%2084.736%20705.198%2084.592%20705.702%2084.304C706.206%2084.016%20706.656%2083.476%20707.052%2082.684C707.448%2081.892%20707.79%2080.704%20708.078%2079.12C708.402%2077.32%20708.672%2074.728%20708.888%2071.344C709.104%2067.96%20709.428%2061.912%20709.86%2053.2H731.082V91H723.414V60.436H717.204C716.7%2070.12%20716.106%2077.014%20715.422%2081.118C714.954%2084.034%20714.198%2086.266%20713.154%2087.814C712.146%2089.326%20710.886%2090.352%20709.374%2090.892C707.898%2091.396%20706.008%2091.648%20703.704%2091.648V84.736ZM737.086%2053.2H744.808V67.564H747.724C751.756%2067.564%20754.762%2068.644%20756.742%2070.804C758.722%2072.928%20759.712%2075.808%20759.712%2079.444C759.712%2083.44%20758.758%2086.374%20756.85%2088.246C754.942%2090.082%20751.9%2091%20747.724%2091H737.086V53.2ZM747.076%2083.98C748.696%2083.98%20749.866%2083.62%20750.586%2082.9C751.342%2082.18%20751.72%2081.028%20751.72%2079.444C751.72%2077.86%20751.342%2076.708%20750.586%2075.988C749.83%2075.232%20748.66%2074.854%20747.076%2074.854H744.808V83.98H747.076ZM795.832%2053.2V91H788.326V81.712L788.92%2067.942L788.65%2067.834L785.248%2077.77L783.358%2082.9H775.798L773.908%2077.77L770.506%2067.834L770.236%2067.942L770.776%2081.712V91H763.324V53.2H771.046L776.986%2067.51C778.318%2070.822%20779.146%2073.018%20779.47%2074.098H779.686C780.01%2073.018%20780.838%2070.822%20782.17%2067.51L788.11%2053.2H795.832ZM159.36%20158H151.692V127.49H143.916V158H136.248V120.2H159.36V158ZM176.511%20158.648C172.659%20158.648%20169.653%20157.514%20167.493%20155.246C165.333%20152.942%20164.253%20149.774%20164.253%20145.742V132.458C164.253%20128.426%20165.333%20125.276%20167.493%20123.008C169.653%20120.704%20172.659%20119.552%20176.511%20119.552C180.363%20119.552%20183.369%20120.704%20185.529%20123.008C187.689%20125.276%20188.769%20128.426%20188.769%20132.458V145.742C188.769%20149.774%20187.689%20152.942%20185.529%20155.246C183.369%20157.514%20180.363%20158.648%20176.511%20158.648ZM176.511%20151.196C177.951%20151.196%20179.031%20150.746%20179.751%20149.846C180.471%20148.91%20180.831%20147.542%20180.831%20145.742V132.458C180.831%20130.658%20180.471%20129.308%20179.751%20128.408C179.031%20127.472%20177.951%20127.004%20176.511%20127.004C175.071%20127.004%20173.991%20127.472%20173.271%20128.408C172.551%20129.308%20172.191%20130.658%20172.191%20132.458V145.742C172.191%20147.542%20172.551%20148.91%20173.271%20149.846C173.991%20150.746%20175.071%20151.196%20176.511%20151.196ZM217.766%20151.736H209.774L208.532%20158H200.594L209.666%20120.2H217.874L226.946%20158H219.008L217.766%20151.736ZM216.254%20144.446L215.39%20140.126C214.886%20137.354%20214.382%20133.898%20213.878%20129.758H213.662C213.05%20134.618%20212.546%20138.074%20212.15%20140.126L211.286%20144.446H216.254ZM252.974%20120.2V158H245.252V142.61H237.476V158H229.754V120.2H237.476V135.32H245.252V120.2H252.974ZM272.931%20151.736H264.939L263.697%20158H255.759L264.831%20120.2H273.039L282.111%20158H274.173L272.931%20151.736ZM271.419%20144.446L270.555%20140.126C270.051%20137.354%20269.547%20133.898%20269.043%20129.758H268.827C268.215%20134.618%20267.711%20138.074%20267.315%20140.126L266.451%20144.446H271.419ZM282.52%20151.736C283.348%20151.736%20284.014%20151.592%20284.518%20151.304C285.022%20151.016%20285.472%20150.476%20285.868%20149.684C286.264%20148.892%20286.606%20147.704%20286.894%20146.12C287.218%20144.32%20287.488%20141.728%20287.704%20138.344C287.92%20134.96%20288.244%20128.912%20288.676%20120.2H309.898V158H302.23V127.436H296.02C295.516%20137.12%20294.922%20144.014%20294.238%20148.118C293.77%20151.034%20293.014%20153.266%20291.97%20154.814C290.962%20156.326%20289.702%20157.352%20288.19%20157.892C286.714%20158.396%20284.824%20158.648%20282.52%20158.648V151.736ZM315.903%20120.2H323.355V128.948C323.355%20130.784%20323.265%20133.142%20323.085%20136.022C322.905%20138.866%20322.671%20141.422%20322.383%20143.69L322.545%20143.852L323.517%20141.206C324.237%20139.226%20324.831%20137.696%20325.299%20136.616L332.481%20120.2H339.987V158H332.535V150.332C332.535%20148.1%20332.607%20145.436%20332.751%20142.34C332.931%20139.244%20333.147%20136.562%20333.399%20134.294L333.237%20134.132L332.265%20136.832C331.041%20140.144%20330.213%20142.322%20329.781%20143.366L323.409%20158H315.903V120.2ZM362.136%20138.236C364.368%20138.884%20365.952%20139.964%20366.888%20141.476C367.86%20142.988%20368.346%20144.86%20368.346%20147.092C368.346%20149.432%20367.788%20151.484%20366.672%20153.248C365.556%20155.012%20364.026%20156.38%20362.082%20157.352C360.174%20158.288%20358.032%20158.756%20355.656%20158.756C353.1%20158.756%20350.868%20158.198%20348.96%20157.082C347.088%20155.93%20345.648%20154.436%20344.64%20152.6C343.632%20150.728%20343.074%20148.694%20342.966%20146.498H350.688C350.724%20147.758%20351.156%20148.892%20351.984%20149.9C352.812%20150.872%20354.036%20151.358%20355.656%20151.358C357.024%20151.358%20358.176%20150.944%20359.112%20150.116C360.048%20149.252%20360.516%20148.082%20360.516%20146.606C360.516%20145.058%20360.066%20143.888%20359.166%20143.096C358.266%20142.304%20356.952%20141.908%20355.224%20141.908H352.632V135.266H354.684C356.376%20135.266%20357.582%20134.906%20358.302%20134.186C359.022%20133.43%20359.382%20132.278%20359.382%20130.73C359.382%20129.506%20359.058%20128.534%20358.41%20127.814C357.798%20127.094%20356.916%20126.734%20355.764%20126.734C352.884%20126.734%20351.372%20128.408%20351.228%20131.756H343.668C343.884%20128.012%20345.018%20125.024%20347.07%20122.792C349.122%20120.524%20352.002%20119.39%20355.71%20119.39C359.166%20119.39%20361.938%20120.416%20364.026%20122.468C366.114%20124.484%20367.158%20127.184%20367.158%20130.568C367.158%20132.476%20366.762%20134.042%20365.97%20135.266C365.214%20136.49%20363.936%20137.48%20362.136%20138.236ZM393.837%20120.2L385.035%20148.766C384.171%20151.574%20383.217%20153.68%20382.173%20155.084C381.165%20156.488%20379.923%20157.442%20378.447%20157.946C377.007%20158.414%20375.063%20158.648%20372.615%20158.648H371.211V151.844H372.885C373.821%20151.844%20374.577%20151.754%20375.153%20151.574C375.729%20151.358%20376.215%20150.962%20376.611%20150.386C377.043%20149.774%20377.457%20148.874%20377.853%20147.686L368.565%20120.2H376.611L381.363%20135.644L385.791%20120.2H393.837ZM426.704%20127.49H419.306V158H411.422V127.49H404.024V120.2H426.704V127.49ZM448.211%20138.668C449.615%20139.46%20450.713%20140.576%20451.505%20142.016C452.297%20143.456%20452.693%20145.022%20452.693%20146.714C452.693%20148.946%20452.207%20150.926%20451.235%20152.654C450.299%20154.346%20448.985%20155.66%20447.293%20156.596C445.637%20157.532%20443.729%20158%20441.569%20158H429.635V120.2H441.407C443.351%20120.2%20445.079%20120.65%20446.591%20121.55C448.103%20122.45%20449.273%20123.71%20450.101%20125.33C450.965%20126.95%20451.397%20128.822%20451.397%20130.946C451.397%20132.386%20451.109%20133.808%20450.533%20135.212C449.957%20136.616%20449.183%20137.768%20448.211%20138.668ZM437.303%20127.436V135.32H440.327C441.407%20135.32%20442.217%20134.978%20442.757%20134.294C443.333%20133.61%20443.621%20132.602%20443.621%20131.27C443.621%20129.974%20443.333%20129.02%20442.757%20128.408C442.181%20127.76%20441.281%20127.436%20440.057%20127.436H437.303ZM440.219%20150.764C443.279%20150.764%20444.809%20149.396%20444.809%20146.66C444.809%20145.292%20444.431%20144.266%20443.675%20143.582C442.919%20142.862%20441.821%20142.502%20440.381%20142.502H437.303V150.764H440.219ZM468.105%20158.648C464.253%20158.648%20461.247%20157.514%20459.087%20155.246C456.927%20152.942%20455.847%20149.774%20455.847%20145.742V132.458C455.847%20128.426%20456.927%20125.276%20459.087%20123.008C461.247%20120.704%20464.253%20119.552%20468.105%20119.552C471.957%20119.552%20474.963%20120.704%20477.123%20123.008C479.283%20125.276%20480.363%20128.426%20480.363%20132.458V145.742C480.363%20149.774%20479.283%20152.942%20477.123%20155.246C474.963%20157.514%20471.957%20158.648%20468.105%20158.648ZM468.105%20151.196C469.545%20151.196%20470.625%20150.746%20471.345%20149.846C472.065%20148.91%20472.425%20147.542%20472.425%20145.742V132.458C472.425%20130.658%20472.065%20129.308%20471.345%20128.408C470.625%20127.472%20469.545%20127.004%20468.105%20127.004C466.665%20127.004%20465.585%20127.472%20464.865%20128.408C464.145%20129.308%20463.785%20130.658%20463.785%20132.458V145.742C463.785%20147.542%20464.145%20148.91%20464.865%20149.846C465.585%20150.746%20466.665%20151.196%20468.105%20151.196ZM505.308%20150.71V158H485.274V120.2H504.768V127.49H492.942V135.32H503.688V142.34H492.942V150.71H505.308ZM509.824%20120.2H517.276V128.948C517.276%20130.784%20517.186%20133.142%20517.006%20136.022C516.826%20138.866%20516.592%20141.422%20516.304%20143.69L516.466%20143.852L517.438%20141.206C518.158%20139.226%20518.752%20137.696%20519.22%20136.616L526.402%20120.2H533.908V158H526.456V150.332C526.456%20148.1%20526.528%20145.436%20526.672%20142.34C526.852%20139.244%20527.068%20136.562%20527.32%20134.294L527.158%20134.132L526.186%20136.832C524.962%20140.144%20524.134%20142.322%20523.702%20143.366L517.33%20158H509.824V120.2ZM522.136%20116.42C520.156%20116.42%20518.518%20115.826%20517.222%20114.638C515.926%20113.414%20515.242%20111.776%20515.17%20109.724H519.868C519.868%20110.408%20520.084%20110.948%20520.516%20111.344C520.948%20111.74%20521.47%20111.938%20522.082%20111.938C522.694%20111.938%20523.216%20111.74%20523.648%20111.344C524.08%20110.948%20524.296%20110.408%20524.296%20109.724H528.994C528.922%20111.848%20528.238%20113.504%20526.942%20114.692C525.682%20115.844%20524.08%20116.42%20522.136%20116.42ZM560.596%20158.648C556.888%20158.648%20554.008%20157.604%20551.956%20155.516C549.94%20153.392%20548.932%20150.368%20548.932%20146.444V131.756C548.932%20127.796%20549.958%20124.754%20552.01%20122.63C554.062%20120.506%20556.942%20119.444%20560.65%20119.444C564.43%20119.444%20567.346%20120.506%20569.398%20122.63C571.45%20124.718%20572.548%20127.76%20572.692%20131.756H565.024C564.916%20130.028%20564.52%20128.786%20563.836%20128.03C563.152%20127.274%20562.072%20126.896%20560.596%20126.896C558.148%20126.896%20556.924%20128.516%20556.924%20131.756V146.444C556.924%20149.612%20558.148%20151.196%20560.596%20151.196C562.072%20151.196%20563.17%20150.818%20563.89%20150.062C564.61%20149.306%20565.024%20148.1%20565.132%20146.444H572.8C572.728%20150.404%20571.63%20153.428%20569.506%20155.516C567.418%20157.604%20564.448%20158.648%20560.596%20158.648ZM596.655%20127.49H589.257V158H581.373V127.49H573.975V120.2H596.655V127.49ZM610.549%20120.2C614.473%20120.2%20617.533%20121.334%20619.729%20123.602C621.925%20125.87%20623.023%20129.02%20623.023%20133.052C623.023%20137.084%20621.925%20140.234%20619.729%20142.502C617.533%20144.734%20614.473%20145.85%20610.549%20145.85H607.255V158H599.587V120.2H610.549ZM610.441%20138.56C611.989%20138.56%20613.159%20138.092%20613.951%20137.156C614.743%20136.22%20615.139%20134.852%20615.139%20133.052C615.139%20131.216%20614.743%20129.83%20613.951%20128.894C613.159%20127.958%20611.989%20127.49%20610.441%20127.49H607.255V138.56H610.441ZM638.598%20151.736H630.606L629.364%20158H621.426L630.498%20120.2H638.706L647.778%20158H639.84L638.598%20151.736ZM637.086%20144.446L636.222%20140.126C635.718%20137.354%20635.214%20133.898%20634.71%20129.758H634.494C633.882%20134.618%20633.378%20138.074%20632.982%20140.126L632.118%20144.446H637.086ZM673.805%20120.2V158H666.083V142.61H658.307V158H650.585V120.2H658.307V135.32H666.083V120.2H673.805ZM679.776%20120.2H687.228V128.948C687.228%20130.784%20687.138%20133.142%20686.958%20136.022C686.778%20138.866%20686.544%20141.422%20686.256%20143.69L686.418%20143.852L687.39%20141.206C688.11%20139.226%20688.704%20137.696%20689.172%20136.616L696.354%20120.2H703.86V158H696.408V150.332C696.408%20148.1%20696.48%20145.436%20696.624%20142.34C696.804%20139.244%20697.02%20136.562%20697.272%20134.294L697.11%20134.132L696.138%20136.832C694.914%20140.144%20694.086%20142.322%20693.654%20143.366L687.282%20158H679.776V120.2ZM728.871%20158H709.863V120.2H717.585V150.71H725.199V120.2H732.921V150.71H736.431V164.426H728.871V158ZM739.634%20120.2H747.572V134.564H749.786C753.71%20134.564%20756.644%20135.644%20758.588%20137.804C760.532%20139.928%20761.504%20142.808%20761.504%20146.444C761.504%20150.44%20760.568%20153.374%20758.696%20155.246C756.824%20157.082%20753.854%20158%20749.786%20158H739.634V120.2ZM765.068%20120.2H772.736V158H765.068V120.2ZM749.138%20150.98C750.65%20150.98%20751.748%20150.62%20752.432%20149.9C753.152%20149.18%20753.512%20148.028%20753.512%20146.444C753.512%20144.86%20753.152%20143.708%20752.432%20142.988C751.748%20142.232%20750.65%20141.854%20749.138%20141.854H747.572V150.98H749.138Z%22%20fill%3D%22black%22%2F%3E%3Cpath%20d%3D%22M454.5%20236L360.536%20198.5L548.464%20198.5L454.5%20236Z%22%20fill%3D%22%23FFBB00%22%2F%3E%3C%2Fsvg%3E')
        ;

        ctx.drawImage(background, 0, 0, 1080, 1920);

        const gradient = ctx.createLinearGradient(0, 1142, 0, 1920);
        gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
        gradient.addColorStop(0.2, 'rgba(0, 0, 0, 0.4)');
        gradient.addColorStop(0.4, 'rgba(0, 0, 0, 0.6)');
        gradient.addColorStop(0.8, 'rgba(0, 0, 0, 0.8)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 1142, 1080, 778);

        ctx.drawImage(bottomImg, 85, 1600, 909, 236);

        ctx.textAlign = 'center';

        ctx.fillStyle = '#FFBB00';
        ctx.font = '140px Akrobat ExtraBold';
        const category_name = convertTextToLines(category.toUpperCase(), ctx.font, 991).reverse();
        for (const i in category_name) {
            ctx.fillText(category_name[i], 1080 / 2, 1375 + 131 - i * 140);
        }

        ctx.fillStyle = '#FFFFFF';

        ctx.font = '40px Wix Madefor Display Medium';
        ctx.fillText('Категория:', 1080 / 2, 1325 + 40 - (category_name.length - 1) * 140);

        ctx.font = '140px Akrobat ExtraBold';
        const film_name = convertTextToLines(film.name.toUpperCase(), ctx.font, 991).reverse();
        for (const i in film_name) {
            ctx.fillText(film_name[i], 1080 / 2, 1129 + 131 - i * 140 - (category_name.length - 1) * 140);
        }

        ctx.font = '40px Wix Madefor Display Medium';
        ctx.fillText('Фильм который Вам подходит', 1080 / 2, 1069 + 40 - (film_name.length - 1) * 140 - (category_name.length - 1) * 140);

        return canvas;
    }

    async shareStory() {
        try {
            this.setPopout(<ScreenSpinner/>);
            const canvas = await this.getStoryCanvas();
            this.setPopout(null);
            await bridge.send('VKWebAppShowStoryBox', {
                background_type: 'image',
                blob: canvas.toDataURL('image/png'),
                attachment: {
                    text: 'go_to',
                    type: 'url',
                    url: `https://vk.com/app${getUrlParams().vk_app_id}`
                }
            });

            if (this.state.token) {
                canvas.toBlob(async function (blob) {
                    const {album_name, album_caption} = this.state.app;
                    await shareWallPhoto(blob, album_caption, `https://vk.com/app${getUrlParams().vk_app_id}`, this.state.token);
                }.bind(this));
            }
        } catch (e) {
            console.error(e);
        }
    }

    async shareAlbum() {
        const
            canvas = await this.getStoryCanvas(),
            blob = await new Promise(resolve => canvas.toBlob(blob => resolve(blob)))
        ;

        const {album_name, album_caption} = this.state.app;
        await shareAlbumPhoto(blob, album_name, album_caption, this.state.token);
    }

    render() {
        const {categories, category, film} = this.state;

        return (
            <View
                {...defaultViewProps.bind(this)()}
            >

                <Panel id='main'>
                    <img alt='icon' className='icon' src={require('../assets/vk_film/token.png')}/>
                    <div className='bottom-container'>
                        <h1>Разреши доступ</h1>
                        <h1>к данным</h1>
                        <span>
                             Чтобы мы проанализировали твои интересы и подобрали фильм под твоё настроение
                        </span>
                        <div
                            className='btn'
                            onClick={async () => {
                                this.setState({token: await getToken('photos', true)});
                                this.go('film');
                            }}
                        >
                            Разрешить
                        </div>
                    </div>
                    <img alt='bg' className='bg' src={require('../assets/vk_film/background.webp')}/>
                </Panel>

                <Panel id='film'>
                    <div className='category' ref={ref => this.category_container = ref}>
                        <img alt='icon' className='icon' src={category && categories[category].poster_url}/>
                        <div className='bottom-container'>
                            <h1>Выбери <span>категорию</span></h1>
                            <select onChange={e => {
                                this.setState({category: e.target.value});
                            }}>
                                {
                                    categories && Object.keys(categories).map((value, index) =>
                                        <option key={`option-${index}`} value={value}>{value}</option>
                                    )
                                }
                            </select>
                            <div
                                className='btn'
                                onClick={this.selectCategory}
                            >
                                Выбрать
                            </div>
                        </div>
                        <img alt='bg' className='bg' src={require('../assets/vk_film/background.webp')}/>
                    </div>
                    <Lottie
                        id={'lottie'}
                        autoplay={false}
                        loop={false}
                        lottieRef={this.lottie_ref}
                        animationData={require(`../assets/vk_film/anim.json`)}
                        height={window.innerHeight}
                        width={window.innerWidth}
                    />
                    <div className='film' ref={ref => this.film_container = ref}>
                        <div className='bottom-container'>
                            <p>Фильм который Вам подходит:</p>
                            <h1>{film && film.name}</h1>
                            <p>Категория:</p>
                            <h1>{category}</h1>
                            <div
                                className='btn'
                                onClick={this.shareStory}
                            >
                                Поделиться в истории
                            </div>
                        </div>
                        <img
                            className='poster' alt='poster'
                            src={film ? film.poster_url : 'https://i.postimg.cc/tyDpm445/image.png'}
                        />
                    </div>
                </Panel>

            </View>
        )
    }

}